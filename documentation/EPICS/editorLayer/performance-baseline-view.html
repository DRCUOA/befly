<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editor Performance Baseline Report</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      line-height: 1.5;
    }
    .container { max-width: 960px; margin: 0 auto; }
    h1 { font-size: 1.5rem; font-weight: 600; margin: 0 0 0.5rem; }
    .meta { color: var(--muted); font-size: 0.85rem; margin-bottom: 1rem; }
    section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    section h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
    }
    .upload-area:hover { border-color: var(--accent); color: var(--text); }
    .upload-area input { display: none; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; }
    .badge { padding: 0.2em 0.5em; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .badge-measured { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .badge-good { color: var(--success); }
    .badge-warn { color: var(--warning); }
    .badge-bad { color: var(--danger); }
    .num { font-variant-numeric: tabular-nums; }
    ul { margin: 0.5rem 0 0; padding-left: 1.25rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editor Performance Baseline Report</h1>
    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept=".json" />
      <p>Drop JSON file here or click to load</p>
      <p class="meta" style="margin-top:0.5rem">Export from /baseline-test in the app</p>
    </div>

    <div id="report" class="hidden">
      <div class="meta" id="meta"></div>

      <section>
        <h2>Measured latency</h2>
        <table>
          <tbody id="latencyTable"></tbody>
        </table>
      </section>

      <section>
        <h2>Document</h2>
        <div id="documentInfo"></div>
      </section>

      <section>
        <h2>Database constraints</h2>
        <div id="dbConstraints"></div>
      </section>

      <section>
        <h2>Data loss risks</h2>
        <div id="dataLossRisks"></div>
      </section>

      <section>
        <h2>Recommendations</h2>
        <ul id="recommendations"></ul>
      </section>
    </div>
  </div>

  <script>
    (function () {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const report = document.getElementById('report');

      uploadArea.addEventListener('click', () => fileInput.click());
      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent)'; });
      uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        const f = e.dataTransfer.files[0];
        if (f && f.name.endsWith('.json')) readFile(f);
      });
      fileInput.addEventListener('change', () => {
        const f = fileInput.files[0];
        if (f) readFile(f);
      });

      function readFile(file) {
        const r = new FileReader();
        r.onload = () => {
          try {
            const data = JSON.parse(r.result);
            render(data);
            report.classList.remove('hidden');
            uploadArea.classList.add('hidden');
          } catch (err) {
            alert('Invalid JSON: ' + (err.message || 'unknown'));
          }
        };
        r.readAsText(file);
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function render(data) {
        const env = data.testEnvironment || {};
        document.getElementById('meta').textContent = [
          'Source: ' + (data.source || 'unknown'),
          'Run: ' + (data.timestamp || '—'),
          (env.platform || '') + ' · ' + (env.userAgent || '').slice(0, 60)
        ].join(' · ');

        const lat = data.measuredLatency || {};
        const tbody = document.getElementById('latencyTable');
        const rows = [
          ['Input events', lat.inputCount],
          ['Avg latency', lat.avgMs != null ? lat.avgMs + 'ms' : '—'],
          ['Max latency', lat.maxMs != null ? lat.maxMs + 'ms' : '—'],
          ['P95 latency', lat.p95Ms != null ? lat.p95Ms + 'ms' : '—'],
          ['P99 latency', lat.p99Ms != null ? lat.p99Ms + 'ms' : '—'],
          ['Events > 16ms', lat.slowEventsPercent != null ? lat.slowEventsPercent + '%' : '—'],
          ['Events > 50ms', lat.verySlowEventsPercent != null ? lat.verySlowEventsPercent + '%' : '—']
        ];
        tbody.innerHTML = rows.map(function (r) {
          return '<tr><td>' + escapeHtml(r[0]) + '</td><td class="num">' + escapeHtml(String(r[1])) + '</td></tr>';
        }).join('');

        const c = data.characteristics || {};
        document.getElementById('documentInfo').innerHTML =
          '<p>' + (c.characterCount || 0).toLocaleString() + ' chars · ' +
          (c.wordCount || 0).toLocaleString() + ' words · ' +
          (c.sizeKB || '—') + ' KB</p>';

        const db = data.databaseConstraints || {};
        document.getElementById('dbConstraints').innerHTML =
          '<p><strong>Field type:</strong> ' + escapeHtml(db.fieldType || '—') + '</p>' +
          '<p><strong>Practical max:</strong> ' + escapeHtml(db.practicalMaxSize || '—') + '</p>' +
          (Array.isArray(db.concerns) ? '<ul><li>' + db.concerns.map(escapeHtml).join('</li><li>') + '</li></ul>' : '');

        const risks = data.dataLossRisks || {};
        const riskEl = document.getElementById('dataLossRisks');
        riskEl.innerHTML = '';
        Object.keys(risks).forEach(function (k) {
          const r = risks[k];
          riskEl.innerHTML += '<p><strong>' + escapeHtml(k) + ':</strong> ' + escapeHtml(r.risk || '') + ' — ' + escapeHtml(r.impact || '') + '</p>';
        });

        const recs = data.recommendations || [];
        document.getElementById('recommendations').innerHTML = recs.map(function (r) {
          return '<li>' + escapeHtml(r.priority || '') + ': ' + escapeHtml(r.item || '') + '</li>';
        }).join('');
      }
    })();
  </script>
</body>
</html>
