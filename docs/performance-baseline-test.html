<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Performance Baseline Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .test-area {
            margin: 20px 0;
        }
        textarea {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .results {
            background: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 13px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: bold;
            color: #374151;
        }
        .metric-value {
            color: #059669;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 10px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 10px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.idle {
            background: #e5e7eb;
            color: #6b7280;
        }
        .status.running {
            background: #dbeafe;
            color: #1e40af;
        }
        .status.complete {
            background: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body>
    <h1>üìä Editor Performance Baseline Test</h1>
    
    <div class="container">
        <h2>Test Configuration</h2>
        <p>This tool measures typing latency and performance characteristics of a native textarea editor similar to the befly writing platform.</p>
        
        <div class="info">
            <strong>Instructions:</strong>
            <ol>
                <li>Select a document size to test</li>
                <li>Click "Load Test Document" to populate the textarea</li>
                <li>Type naturally in the textarea for at least 10 seconds</li>
                <li>Review the real-time performance metrics below</li>
            </ol>
        </div>
    </div>

    <div class="container">
        <h2>Document Size Selection</h2>
        <button onclick="loadDocument('small')">Small (1KB ~ 200 words)</button>
        <button onclick="loadDocument('medium')">Medium (10KB ~ 2,000 words)</button>
        <button onclick="loadDocument('large')">Large (100KB ~ 20,000 words)</button>
        <button onclick="loadDocument('xlarge')">X-Large (500KB ~ 100,000 words)</button>
        <button onclick="clearDocument()">Clear</button>
    </div>

    <div class="container">
        <h2>Test Editor</h2>
        <div class="status idle" id="status">Status: Idle - Load a document to begin</div>
        <div class="test-area">
            <textarea id="editor" placeholder="Load a test document or start typing..."></textarea>
        </div>
        <div>
            <strong>Document Info:</strong>
            <div id="docInfo" class="results">
                <div class="metric">
                    <span class="metric-label">Character Count:</span>
                    <span class="metric-value" id="charCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Word Count:</span>
                    <span class="metric-value" id="wordCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Size:</span>
                    <span class="metric-value" id="sizeInfo">0 bytes</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Performance Metrics</h2>
        <div class="results" id="metrics">
            <div class="metric">
                <span class="metric-label">Input Events Processed:</span>
                <span class="metric-value" id="inputCount">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">Average Input Latency:</span>
                <span class="metric-value" id="avgLatency">N/A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Max Input Latency:</span>
                <span class="metric-value" id="maxLatency">N/A</span>
            </div>
            <div class="metric">
                <span class="metric-label">P95 Latency:</span>
                <span class="metric-value" id="p95Latency">N/A</span>
            </div>
            <div class="metric">
                <span class="metric-label">P99 Latency:</span>
                <span class="metric-value" id="p99Latency">N/A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Input Events > 16ms:</span>
                <span class="metric-value" id="slowEvents">0 (0%)</span>
            </div>
            <div class="metric">
                <span class="metric-label">Input Events > 50ms:</span>
                <span class="metric-value" id="verySlowEvents">0 (0%)</span>
            </div>
        </div>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Performance Thresholds:</strong><br>
            ‚Ä¢ Good: &lt;16ms (60fps)<br>
            ‚Ä¢ Acceptable: 16-50ms<br>
            ‚Ä¢ Poor: &gt;50ms (noticeable lag)
        </div>
    </div>

    <div class="container">
        <h2>Undo/Redo Testing</h2>
        <p>Test browser native undo/redo behavior with programmatic changes:</p>
        <button onclick="testProgrammaticChange()">Apply Programmatic Change</button>
        <button onclick="testInsertText()">Insert Text Programmatically</button>
        <div class="info" style="margin-top: 10px;">
            <strong>Test Steps:</strong><br>
            1. Type some text in the editor<br>
            2. Click "Apply Programmatic Change" to modify text via JavaScript<br>
            3. Try Ctrl+Z (Cmd+Z) to undo - does it undo your typing or the programmatic change?<br>
            4. Document the behavior in the results
        </div>
    </div>

    <div class="container">
        <h2>Export Results</h2>
        <button onclick="exportResults()">Export Results as JSON</button>
        <button onclick="copyResults()">Copy Results to Clipboard</button>
    </div>

    <script>
        // Performance tracking
        let metrics = {
            inputCount: 0,
            latencies: [],
            startTime: null,
            lastInputTime: null
        };

        const editor = document.getElementById('editor');
        const statusEl = document.getElementById('status');

        // Sample text generator
        function generateText(targetSize) {
            const lorem = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. ";
            const words = lorem.split(' ');
            let text = '';
            
            while (new Blob([text]).size < targetSize) {
                text += words[Math.floor(Math.random() * words.length)] + ' ';
                if (Math.random() > 0.9) text += '\n\n';
            }
            
            return text.substring(0, text.length - 1);
        }

        function loadDocument(size) {
            let targetSize;
            let docName;
            
            switch(size) {
                case 'small':
                    targetSize = 1024; // 1KB
                    docName = 'Small (1KB)';
                    break;
                case 'medium':
                    targetSize = 10240; // 10KB
                    docName = 'Medium (10KB)';
                    break;
                case 'large':
                    targetSize = 102400; // 100KB
                    docName = 'Large (100KB)';
                    break;
                case 'xlarge':
                    targetSize = 512000; // 500KB
                    docName = 'X-Large (500KB)';
                    break;
            }
            
            editor.value = generateText(targetSize);
            updateDocInfo();
            resetMetrics();
            statusEl.textContent = `Status: Ready - ${docName} document loaded`;
            statusEl.className = 'status running';
        }

        function clearDocument() {
            editor.value = '';
            updateDocInfo();
            resetMetrics();
            statusEl.textContent = 'Status: Idle - Load a document to begin';
            statusEl.className = 'status idle';
        }

        function resetMetrics() {
            metrics = {
                inputCount: 0,
                latencies: [],
                startTime: Date.now(),
                lastInputTime: Date.now()
            };
            updateMetrics();
        }

        function updateDocInfo() {
            const text = editor.value;
            const charCount = text.length;
            const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            const size = new Blob([text]).size;
            
            document.getElementById('charCount').textContent = charCount.toLocaleString();
            document.getElementById('wordCount').textContent = wordCount.toLocaleString();
            document.getElementById('sizeInfo').textContent = `${size.toLocaleString()} bytes (${(size/1024).toFixed(2)} KB)`;
        }

        function updateMetrics() {
            const latencies = metrics.latencies;
            
            document.getElementById('inputCount').textContent = metrics.inputCount;
            
            if (latencies.length === 0) {
                document.getElementById('avgLatency').textContent = 'N/A';
                document.getElementById('maxLatency').textContent = 'N/A';
                document.getElementById('p95Latency').textContent = 'N/A';
                document.getElementById('p99Latency').textContent = 'N/A';
                document.getElementById('slowEvents').textContent = '0 (0%)';
                document.getElementById('verySlowEvents').textContent = '0 (0%)';
                return;
            }
            
            const avg = latencies.reduce((a, b) => a + b, 0) / latencies.length;
            const max = Math.max(...latencies);
            const sorted = [...latencies].sort((a, b) => a - b);
            const p95 = sorted[Math.floor(sorted.length * 0.95)];
            const p99 = sorted[Math.floor(sorted.length * 0.99)];
            const slowCount = latencies.filter(l => l > 16).length;
            const verySlowCount = latencies.filter(l => l > 50).length;
            
            document.getElementById('avgLatency').textContent = `${avg.toFixed(2)}ms`;
            document.getElementById('maxLatency').textContent = `${max.toFixed(2)}ms`;
            document.getElementById('p95Latency').textContent = `${p95.toFixed(2)}ms`;
            document.getElementById('p99Latency').textContent = `${p99.toFixed(2)}ms`;
            document.getElementById('slowEvents').textContent = `${slowCount} (${(slowCount/latencies.length*100).toFixed(1)}%)`;
            document.getElementById('verySlowEvents').textContent = `${verySlowCount} (${(verySlowCount/latencies.length*100).toFixed(1)}%)`;
        }

        // Input event handler with performance measurement
        editor.addEventListener('input', function(e) {
            const startTime = performance.now();
            
            // Simulate Vue reactivity overhead
            const text = editor.value;
            
            const endTime = performance.now();
            const latency = endTime - startTime;
            
            metrics.inputCount++;
            metrics.latencies.push(latency);
            metrics.lastInputTime = Date.now();
            
            updateDocInfo();
            updateMetrics();
            
            if (statusEl.className !== 'status complete') {
                statusEl.textContent = 'Status: Measuring - Type naturally to collect data';
                statusEl.className = 'status running';
            }
        });

        // Programmatic change tests for undo/redo
        function testProgrammaticChange() {
            const text = editor.value;
            const newText = text.replace(/the/gi, 'THE');
            editor.value = newText;
            updateDocInfo();
            alert('Programmatic change applied (replaced "the" with "THE"). Try Ctrl+Z to test undo behavior.');
        }

        function testInsertText() {
            const pos = editor.selectionStart;
            const text = editor.value;
            const before = text.substring(0, pos);
            const after = text.substring(pos);
            editor.value = before + '[PROGRAMMATIC INSERT]' + after;
            editor.selectionStart = editor.selectionEnd = pos + '[PROGRAMMATIC INSERT]'.length;
            updateDocInfo();
            alert('Text inserted programmatically at cursor position. Try Ctrl+Z to test undo behavior.');
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                documentSize: new Blob([editor.value]).size,
                characterCount: editor.value.length,
                wordCount: editor.value.trim().split(/\s+/).length,
                metrics: {
                    inputCount: metrics.inputCount,
                    averageLatency: metrics.latencies.length > 0 ? 
                        metrics.latencies.reduce((a, b) => a + b, 0) / metrics.latencies.length : 0,
                    maxLatency: metrics.latencies.length > 0 ? Math.max(...metrics.latencies) : 0,
                    p95Latency: metrics.latencies.length > 0 ? 
                        [...metrics.latencies].sort((a, b) => a - b)[Math.floor(metrics.latencies.length * 0.95)] : 0,
                    p99Latency: metrics.latencies.length > 0 ? 
                        [...metrics.latencies].sort((a, b) => a - b)[Math.floor(metrics.latencies.length * 0.99)] : 0,
                    slowEventsPercent: metrics.latencies.length > 0 ?
                        (metrics.latencies.filter(l => l > 16).length / metrics.latencies.length * 100) : 0,
                    verySlowEventsPercent: metrics.latencies.length > 0 ?
                        (metrics.latencies.filter(l => l > 50).length / metrics.latencies.length * 100) : 0
                },
                browser: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `editor-performance-baseline-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyResults() {
            const results = document.getElementById('metrics').innerText;
            const docInfo = document.getElementById('docInfo').innerText;
            const fullResults = `Document Information:\n${docInfo}\n\nPerformance Metrics:\n${results}`;
            
            navigator.clipboard.writeText(fullResults).then(() => {
                alert('Results copied to clipboard!');
            });
        }

        // Initialize
        updateDocInfo();
        updateMetrics();
    </script>
</body>
</html>
